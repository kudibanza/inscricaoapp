<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Cadastro de Candidato</title>
</head>

<body>
    <h1>Cadastro de Candidato</h1>
    <form th:action="@{/candidato}" th:object="${candidato}" method="post">
        <label for="nome">Nome:</label>
        <input type="text" th:field="*{nome}" required /><br />

        <label for="nif">NIF:</label>
        <input type="text" th:field="*{nif}" required /><br />

        <label for="moradia">Moradia:</label>
        <input type="text" th:field="*{moradia}" required /><br />

        <label for="cursoMedio">Curso Médio:</label>
        <input type="text" th:field="*{cursoMedio}" required /><br />

        <label for="anoConclusao">Ano de Conclusão:</label>
        <input type="number" th:field="*{anoConclusao}" required /><br />

        <label for="media">Média:</label>
        <input type="number" step="0.01" th:field="*{media}" required /><br />

        <label for="codigo_code">Código:</label>
        <input type="text" value="" id="codigo_code" th:field="*{code.codigo}" required="true"
            oninput="fetchNumOpcoes()" />

        <label for="numOpcoes">Número de Opções:</label>
        <input type="text" id="numOpcoes" name="numOpcoes" readonly />

        <div id="cursoOpcoes">
            <label for="cursoPrimeiraOpcao">Curso Primeira Opção:</label>
            <select th:field="*{cursoPrimeiraOpcao}">
                <option th:each="curso : ${cursos}" th:value="${curso.id}" th:text="${curso.descricao}"></option>
            </select>

            <div id="segundaOpcao" style="display: none;">
                <label for="cursoSegundaOpcao">Curso Segunda Opção:</label>
                <select th:field="*{cursoSegundaOpcao}">
                    <option value="" selected>Selecione uma 2ª Opção</option>
                    <option th:each="curso : ${cursos}" th:value="${curso.id}" th:text="${curso.descricao}"></option>
                </select>
            </div>
        </div>

        <button type="submit">Cadastrar</button>
    </form>

    <!-- Mensagem de erro se o código for inválido -->
    <div th:if="${codigoInvalido}" style="color: red;">
        Código inválido! Por favor, verifique e tente novamente. <br>
        Caso continue contacte o Técnico.
    </div>
    <div id="mensagemErro" style="color: red;"></div>

    <h2>Candidatos Inscritos</h2>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>NIF</th>
                <th>Curso Primeira Opção</th>
                <th>Curso Segunda Opção</th>
                <th>Instituição</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="candidato : ${candidatos}">
                <td th:text="${candidato.nome}"></td>
                <td th:text="${candidato.nif}"></td>
                <td th:text="${candidato.cursoPrimeiraOpcao.descricao}"></td>
                <td th:text="${candidato.cursoSegundaOpcao != null ? candidato.cursoSegundaOpcao.descricao : 'N/A'}">
                </td>
                <td>
                    <span th:text="${candidato.cursoPrimeiraOpcao.instituicao.nome}"></span><br />
                    <span
                        th:text="${candidato.cursoSegundaOpcao != null ? candidato.cursoSegundaOpcao.instituicao.nome : 'N/A'}"></span>
                </td>
            </tr>
        </tbody>
    </table>


    <script>
        function updateCourseOptions(numeroDeOpcoes) {
            const segundaOpcao = document.getElementById('segundaOpcao');
            if (numeroDeOpcoes == 2) {
                segundaOpcao.style.display = 'block';
                codigo_code.value = "";
            } else {

                codigo_code.value = "";
                segundaOpcao.style.display = 'none';

            }
        }

        async function fetchNumOpcoes() {
            const codigo = document.getElementById('codigo_code').value;
            const mensagemErro = document.getElementById('mensagemErro');
            mensagemErro.textContent = ''; // Limpa a mensagem de erro

            if (codigo) {
                const response = await fetch(`/code/${codigo}`);
                if (response.ok) {
                    const numOpcoes = await response.json();
                    document.getElementById('numOpcoes').value = numOpcoes;
                    if (numOpcoes == 2) {
                        segundaOpcao.style.display = 'block';
                        
                    } else {
                        if (numOpcoes == 1)
                        segundaOpcao.style.display = 'none';
                    }
                } else {
                    mensagemErro.textContent = await response.text(); // Mostra a mensagem de erro
                    document.getElementById('numOpcoes').value = '';
                }
            } else {
                document.getElementById('numOpcoes').value = '';
            }
        }

    </script>
</body>

</html>